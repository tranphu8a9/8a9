<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>THỜI KHÓA BIỂU LỚP 8A9</title>
<style>
  :root{
    --col-2: #cfefff; --col-3: #dfffe9; --col-4: #fff4d6;
    --col-5: #ffe9ea; --col-6: #f3eeff; --col-7: #fff0f7;
    --head-2: #6bb5ff; --head-3: #78e8c6; --head-4: #fbc971;
    --head-5: #ffa1a1; --head-6: #bfa8ff; --head-7: #ffb6e0;
  }
  body{font-family:"Segoe UI",Roboto,Arial,sans-serif;background:#f7f9fc;margin:0;}
  .wrap{max-width:1100px;margin:28px auto;background:rgba(255,255,255,0.92);
    border-radius:12px;padding:18px;box-shadow:0 8px 30px rgba(0,0,0,0.15);}
  header{text-align:center;margin-bottom:14px;}
  h1{margin:6px 0;font-size:28px;letter-spacing:1px;color:#113;}
  table{width:100%;border-collapse:collapse;border-radius:8px;overflow:hidden;}
  thead th{padding:10px 8px;color:#fff;font-size:14px;text-align:center;}
  thead th:first-child{background:transparent;color:#333;text-align:left;
    padding-left:14px;font-weight:700;}
  thead th:nth-child(2){background:var(--head-2);}
  thead th:nth-child(3){background:var(--head-3);}
  thead th:nth-child(4){background:var(--head-4);color:#111;}
  thead th:nth-child(5){background:var(--head-5);color:#111;}
  thead th:nth-child(6){background:var(--head-6);}
  thead th:nth-child(7){background:var(--head-7);color:#111;}
  td{padding:10px 8px;border:1px solid rgba(0,0,0,0.06);font-size:14px;text-align:center;}
  tbody td:first-child{cursor:pointer;text-align:center;font-weight:600;background:#fafafa;width:88px;}
  tbody td:nth-child(2){background:var(--col-2);}
  tbody td:nth-child(3){background:var(--col-3);}
  tbody td:nth-child(4){background:var(--col-4);}
  tbody td:nth-child(5){background:var(--col-5);}
  tbody td:nth-child(6){background:var(--col-6);}
  tbody td:nth-child(7){background:var(--col-7);}
  .session-row td{background:#eef3f7;text-align:center;font-weight:700;color:#333;cursor:default;}
  .morning td:not(:first-child){color:#0066CC;font-weight:600;}
  .afternoon td:not(:first-child){color:#8B4513;font-weight:600;}
  .empty{color:#8a8a8a;font-weight:500;cursor:default;}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>THỜI KHÓA BIỂU LỚP 8A9</h1>
      <div id="info-date" style="font-size:15px;color:#333;font-weight:600;margin:6px 0;"></div>
      <div id="current-period" style="font-size:14px;color:#006600;margin:4px 0;"></div>
      <div id="status" style="font-size:13px;color:#666;"></div>
    </header>
    <table id="tkb">
      <thead>
        <tr>
          <th>Tiết</th>
          <th>Thứ 2</th><th>Thứ 3</th><th>Thứ 4</th>
          <th>Thứ 5</th><th>Thứ 6</th><th>Thứ 7</th>
        </tr>
      </thead>
      <tbody>
        <tr class="session-row"><td colspan="7">Buổi Sáng</td></tr>
        <tr class="session-row"><td colspan="7">Buổi Chiều</td></tr>
      </tbody>
    </table>
  </div>

<script>
(async function(){
  const EXEC_URL = "https://script.google.com/macros/s/AKfycbz04IeeS7Bw93cX2hWDwYX76VrHtb2ExNEQ0_4fx24hLDQcLCJSewTV13h-UUlGQh9p/exec";

  try {
    const res = await fetch(EXEC_URL + "?_=" + Date.now(), { cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const payload = await res.json();

    const tbody = document.querySelector("#tkb tbody");
    const weekdays = ["THỨ 2","THỨ 3","THỨ 4","THỨ 5","THỨ 6","THỨ 7"];
    const rows = payload.schedule || [];
    const times = {}; // lưu thời gian tiết từ Sheet2

    if (payload.detail) {
      payload.detail.forEach(d => {
        times[d["Mã tiết"]] = { start: d["Giờ bắt đầu"], end: d["Giờ kết thúc"], name: d["Tên tiết"] };
      });
    }

    function makeRow(r, cls){
      const tr = document.createElement("tr"); tr.className = cls;
      // gắn data-ma vào cột đầu tiên (tên tiết)
      tr.innerHTML = `<td data-ma="${r["Mã tiết"]}" class="period-cell">${r["tiết"]}</td>`;
      weekdays.forEach(d => {
        const txt = r[d] || '<span class="empty">—</span>';
        tr.innerHTML += `<td>${txt}</td>`;
      });
      return tr;
    }

    // Buổi sáng (Tiết 1 trên cùng)
    const morningMarker = tbody.querySelectorAll(".session-row")[0];
    for (let i = 4; i >= 0; i--) {
      const r = rows[i]; if (!r) continue;
      tbody.insertBefore(makeRow(r,"morning"), morningMarker.nextSibling);
    }

    // Buổi chiều (Tiết 6 trên cùng)
    const afternoonMarker = tbody.querySelectorAll(".session-row")[1];
    for (let i = 9; i >= 5; i--) {
      const r = rows[i]; if (!r) continue;
      tbody.insertBefore(makeRow(r,"afternoon"), afternoonMarker.nextSibling);
    }

    // Popup khi click vào tên tiết (cột đầu tiên)
    tbody.addEventListener("click", e => {
      const td = e.target.closest(".period-cell");
      if (!td) return;
      const ma = td.getAttribute("data-ma");
      const info = times[ma];
      if (info) {
        alert(`${info.name} — từ ${info.start} đến ${info.end}`);
      }
    });

    // Hiện thông tin tiết hiện tại
    const now = new Date();
    const curStr = now.toTimeString().slice(0,5); // HH:MM
    let currentInfo = "Hiện đang ngoài giờ học";
    Object.keys(times).forEach(ma => {
      const t = times[ma];
      if (curStr >= t.start && curStr <= t.end) {
        currentInfo = `HIỆN TẠI LÀ ${t.name} — từ ${t.start} đến ${t.end}`;
      }
    });
    document.getElementById("current-period").textContent = currentInfo;

    document.getElementById("status").textContent = "Dữ liệu được tải thành công";
  } catch (err) {
    console.error(err);
    document.getElementById("status").textContent = "Không thể tải dữ liệu: " + err.message;
  }
})();

// Hiển thị ngày & tuần học
(function(){
  function formatVietnameseDate(date){
    const days=['Chủ Nhật','Thứ Hai','Thứ Ba','Thứ Tư','Thứ Năm','Thứ Sáu','Thứ Bảy'];
    return `${days[date.getDay()]}, ${date.getDate()} tháng ${date.getMonth()+1} năm ${date.getFullYear()}`;
  }
  function getWeekNumber(date){
    const start=new Date(2025,8,8); // 8/9/2025
    const diffMs=date-start; if(diffMs<0) return 0;
    return Math.floor(diffMs/(1000*60*60*24*7))+1;
  }
  const now=new Date();
  const week=getWeekNumber(now);
  document.getElementById("info-date").textContent =
    week>0 ? `Hôm nay là ${formatVietnameseDate(now)} — Tuần học thứ ${week}`
            : `Hôm nay là ${formatVietnameseDate(now)} — Chưa đến tuần học thứ 1 (bắt đầu từ 8/9/2025)`;
})();
</script>
</body>
</html>
