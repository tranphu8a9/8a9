<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>THỜI KHÓA BIỂU LỚP 8A9</title>
<style>
  :root{
    --col-2: #e8f9ff; /* Thứ 2 */
    --col-3: #e8fff0; /* Thứ 3 */
    --col-4: #fff9e6; /* Thứ 4 */
    --col-5: #fff0f1; /* Thứ 5 */
    --col-6: #f8f4ff; /* Thứ 6 */
    --col-7: #fff6fb; /* Thứ 7 */

    --head-2: #0ea5ff;
    --head-3: #2dd4bf;
    --head-4: #f59e0b;
    --head-5: #fb7185;
    --head-6: #8b5cf6;
    --head-7: #f472b6;
  }

  html,body{height:100%;margin:0;font-family: "Segoe UI", Roboto, Arial, sans-serif;background:#f4f6f8;}
  .wrap{
    max-width:1100px;margin:28px auto;padding:18px;background:#fff;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.08);
  }
  header{text-align:center;margin-bottom:12px;}
  h1{margin:6px 0;font-size:26px;color:#0b3;}
  #date-row{font-size:14px;color:#444;margin-top:6px;}
  #week-row{font-weight:700;color:#222;margin-top:6px;}
  #now-status{margin-top:10px;font-size:15px;color:#b33;font-weight:700;text-align:right;}

  table{width:100%;border-collapse:collapse;margin-top:12px;border-radius:8px;overflow:hidden;}
  thead th{padding:10px 8px;color:#fff;font-size:14px;text-align:center;}
  thead th:first-child{background:transparent;color:#333;text-align:left;padding-left:12px;font-weight:700;}
  thead th:nth-child(2){background:var(--head-2)}
  thead th:nth-child(3){background:var(--head-3)}
  thead th:nth-child(4){background:var(--head-4); color:#111;}
  thead th:nth-child(5){background:var(--head-5); color:#111;}
  thead th:nth-child(6){background:var(--head-6)}
  thead th:nth-child(7){background:var(--head-7); color:#111;}

  td{padding:9px 8px;border:1px solid rgba(0,0,0,0.06);vertical-align:middle;font-size:14px;}
  tbody td:first-child{ text-align:center; font-weight:600; background:#fafafa; width:110px; }

  tbody td:nth-child(2){ background:var(--col-2); }
  tbody td:nth-child(3){ background:var(--col-3); }
  tbody td:nth-child(4){ background:var(--col-4); }
  tbody td:nth-child(5){ background:var(--col-5); }
  tbody td:nth-child(6){ background:var(--col-6); }
  tbody td:nth-child(7){ background:var(--col-7); }

  .session-row td{ background:#f1f5f9; text-align:center; font-weight:700; color:#333; border-top:2px solid rgba(0,0,0,0.04); }

  .morning td:not(.session-td) { color:#0066CC; font-weight:600; }
  .afternoon td:not(.session-td) { color:#8B4513; font-weight:600; }

  .empty { color: #8a8a8a; font-weight:500; text-align:center; }

  /* modal */
  .modal-back{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:1000;}
  .modal{background:#fff;padding:16px;border-radius:8px;min-width:280px;max-width:420px;box-shadow:0 10px 40px rgba(0,0,0,0.2);}
  .modal h3{margin:0 0 8px;font-size:16px;}
  .modal p{margin:6px 0;color:#333;}
  .btn{display:inline-block;padding:8px 12px;border-radius:6px;background:#0b74d1;color:#fff;text-decoration:none;border:none;cursor:pointer;}

  @media (max-width:820px){
    .wrap{margin:12px;padding:12px;}
    thead th, td{font-size:12px;padding:6px;}
    tbody td:first-child{width:60px;font-size:13px;}
    h1{font-size:20px;}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>THỜI KHÓA BIỂU LỚP 8A9</h1>
      <div id="date-row"></div>
      <div id="week-row"></div>
    </header>

    <div id="table-wrap">
      <table id="tkb">
        <thead>
          <tr>
            <th>Tiết</th>
            <th>Thứ 2</th>
            <th>Thứ 3</th>
            <th>Thứ 4</th>
            <th>Thứ 5</th>
            <th>Thứ 6</th>
            <th>Thứ 7</th>
          </tr>
        </thead>
        <tbody id="tkb-body">
          <!-- rows sẽ được render bằng JS -->
        </tbody>
      </table>
    </div>

    <div id="now-status">Đang tải dữ liệu...</div>
  </div>

  <!-- modal -->
  <div id="modal-back" class="modal-back">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="modal-title">Tiết …</h3>
      <p id="modal-body"></p>
      <div style="text-align:right;margin-top:8px;">
        <button id="modal-close" class="btn">Đóng</button>
      </div>
    </div>
  </div>

<script>
(async function(){
  // ====== Cấu hình ======
  const EXEC_URL = "https://script.google.com/macros/s/AKfycbz04IeeS7Bw93cX2hWDwYX76VrHtb2ExNEQ0_4fx24hLDQcLCJSewTV13h-UUlGQh9p/exec";
  // Tuỳ bạn: nếu dùng Apps Script khác, thay URL ở trên.

  // Hàm định dạng ngày tiếng Việt
  function formatVietnameseDate(date) {
    const days = ['Chủ Nhật','Thứ Hai','Thứ Ba','Thứ Tư','Thứ Năm','Thứ Sáu','Thứ Bảy'];
    const dayName = days[date.getDay()];
    const d = date.getDate();
    const m = date.getMonth() + 1;
    const y = date.getFullYear();
    return `${dayName}, ${d} tháng ${m} năm ${y}`;
  }

  // Tuần học tính từ 8/9/2025 (Tuần 1 bắt đầu ngày này)
  function getWeekNumber(date) {
    const startDate = new Date(2025, 8, 8); // tháng 8 = tháng 9 (0-based)
    const diffMs = date - startDate;
    if (diffMs < 0) return 0;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    return Math.floor(diffDays / 7) + 1;
  }

  // Parse "HH:MM" -> Date object (today)
  function parseTimeToDate(timeStr) {
    const now = new Date();
    const parts = (""+timeStr).trim().split(":");
    if (parts.length < 2) return null;
    const d = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(parts[0],10), parseInt(parts[1],10), 0);
    return d;
  }

  // Hiển thị ngày và tuần
  const now = new Date();
  document.getElementById("date-row").textContent = formatVietnameseDate(now);
  const wk = getWeekNumber(now);
  document.getElementById("week-row").textContent = wk > 0 ? `Tuần học thứ ${wk}` : "Chưa đến tuần học thứ 1 (bắt đầu từ 08/09/2025)";

  // Fetch data từ Apps Script
  let sheet1, sheet2;
  try {
    const res = await fetch(EXEC_URL + "?_=" + Date.now(), { cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const payload = await res.json();
    if (payload.error) throw new Error(payload.error);
    sheet1 = payload.sheet1 || [];
    sheet2 = payload.sheet2 || [];
  } catch (err) {
    document.getElementById("now-status").textContent = "Không thể tải dữ liệu: " + err.message;
    buildEmptyTable();
    return;
  }

  // --- Xử lý dữ liệu ---
  // sheet1: assume header at row 0, data rows start row1
  // sheet1 columns: A(code), B(tên tiết), C..H (Thứ 2..Thứ7)
  // sheet2: header row0, data rows row1. ColA: mã tiết, ColB: tên tiết, ColC: giờ bắt đầu, ColD: giờ kết thúc

  // Build map mã tiết -> {name, start, end}
  const timeMap = {}; // key: mã tiết (string), value: {name, start: "07:00", end: "07:45", startDate, endDate}
  for (let i = 1; i < sheet2.length; i++) {
    const row = sheet2[i];
    if (!row) continue;
    const code = (row[0] != null ? String(row[0]).trim() : "");
    if (!code) continue;
    const name = row[1] != null ? String(row[1]) : code;
    const start = row[2] != null ? String(row[2]).trim() : "";
    const end = row[3] != null ? String(row[3]).trim() : "";
    const startDate = start ? parseTimeToDate(start) : null;
    const endDate = end ? parseTimeToDate(end) : null;
    timeMap[code] = { code, name, start, end, startDate, endDate };
  }

  // Prepare table rendering: We'll render 11 rows: session header, 5 morning, session header, 5 afternoon (matching your spec)
  // Data rows in sheet1: assume header row0, rows 1..5 -> morning (tiết 1..5), rows 6..10 -> afternoon (tiết1..5)
  const tbody = document.getElementById("tkb-body");
  tbody.innerHTML = "";

  // Session header - Buổi Sáng
  const trHeadMorning = document.createElement("tr");
  trHeadMorning.className = "session-row";
  const thm = document.createElement("td");
  thm.colSpan = 7;
  thm.className = "session-td";
  thm.textContent = "Buổi Sáng";
  trHeadMorning.appendChild(thm);
  tbody.appendChild(trHeadMorning);

  // Morning 5 tiết
  for (let rr = 1; rr <= 5; rr++) { // sheet1 row index rr (1..5)
    const row = sheet1[rr] || [];
    const tr = document.createElement("tr");
    tr.className = "morning";
    const labelTd = document.createElement("td");
    // Use sheet1[rr][1] as tên tiết (B column) if present, else "Tiết X"
    const tname = row[1] ? String(row[1]) : `Tiết ${rr} (sáng)`;
    labelTd.textContent = tname + (row[2] ? ` (${row[0]||""})` : "");
    tr.appendChild(labelTd);

    for (let c = 2; c <= 7; c++) { // columns C..H -> indices 2..7 in array
      const td = document.createElement("td");
      const cellText = row[c] != null && String(row[c]).trim() !== "" ? String(row[c]) : "";
      td.innerHTML = cellText ? escapeHtml(cellText).replace(/\n/g,"<br>") : '<span class="empty">—</span>';
      // attach dataset info: code of tiết = sheet1[rr][0]
      td.dataset.periodCode = row[0] != null ? String(row[0]).trim() : "";
      td.dataset.periodRowIndex = rr; // helpful reference
      td.dataset.colIndex = c; // which weekday
      // add click listener
      td.addEventListener("click", onCellClick);
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }

  // Session header - Buổi Chiều
  const trHeadAf = document.createElement("tr");
  trHeadAf.className = "session-row";
  const tha = document.createElement("td");
  tha.colSpan = 7;
  tha.className = "session-td";
  tha.textContent = "Buổi Chiều";
  trHeadAf.appendChild(tha);
  tbody.appendChild(trHeadAf);

  // Afternoon 5 tiết (sheet1 rows 6..10)
  for (let rr = 6; rr <= 10; rr++) {
    const row = sheet1[rr] || [];
    const idx = rr - 5; // 1..5 for label
    const tr = document.createElement("tr");
    tr.className = "afternoon";
    const labelTd = document.createElement("td");
    const tname = row[1] ? String(row[1]) : `Tiết ${idx} (chiều)`;
    labelTd.textContent = tname + (row[0] ? ` (${row[0]})` : "");
    tr.appendChild(labelTd);

    for (let c = 2; c <= 7; c++) {
      const td = document.createElement("td");
      const cellText = row[c] != null && String(row[c]).trim() !== "" ? String(row[c]) : "";
      td.innerHTML = cellText ? escapeHtml(cellText).replace(/\n/g,"<br>") : '<span class="empty">—</span>';
      td.dataset.periodCode = row[0] != null ? String(row[0]).trim() : "";
      td.dataset.periodRowIndex = rr;
      td.dataset.colIndex = c;
      td.addEventListener("click", onCellClick);
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }

  // ===== Kiểm tra "hiện tại là tiết ..." =====
  const nowStatusEl = document.getElementById("now-status");
  const nowDate = new Date();

  // Build an array of time ranges from timeMap
  const ranges = [];
  Object.values(timeMap).forEach(t=>{
    if (t.startDate && t.endDate) {
      // ensure end > start; if end < start assume next day (rare)
      ranges.push({ code: t.code, name: t.name, start: t.startDate, end: t.endDate });
    }
  });

  // Find if now is in any range
  let current = null;
  for (const r of ranges) {
    // convert r.start and r.end to today's Date objects (may be already)
    const s = parseTimeToDate(r.start.getHours ? formatHM(r.start.getHours(), r.start.getMinutes()) : r.start);
    const e = parseTimeToDate(r.end.getHours ? formatHM(r.end.getHours(), r.end.getMinutes()) : r.end);
    if (!s || !e) continue;
    if (s <= nowDate && nowDate <= e) {
      current = { code: r.code, name: r.name, start: s, end: e };
      break;
    }
  }

  if (current) {
    nowStatusEl.textContent = `HIỆN TẠI LÀ TIẾT ${current.code} — ${current.name} (${formatHM(current.start.getHours(), current.start.getMinutes())} - ${formatHM(current.end.getHours(), current.end.getMinutes())})`;
  } else {
    nowStatusEl.textContent = `Hiện đang ngoài giờ học`;
  }

  // --- Modal xử lý click ---
  const modalBack = document.getElementById("modal-back");
  const modalTitle = document.getElementById("modal-title");
  const modalBody = document.getElementById("modal-body");
  document.getElementById("modal-close").addEventListener("click", ()=> modalBack.style.display = "none");

  function onCellClick(evt) {
    const td = evt.currentTarget;
    const code = td.dataset.periodCode || "";
    const rowIdx = Number(td.dataset.periodRowIndex || -1);
    const weekdayIndex = Number(td.dataset.colIndex || -1);
    const subjectText = td.textContent.trim();

    // Look up timeMap
    const tm = timeMap[code];
    if (tm) {
      modalTitle.textContent = `Tiết ${code} — ${tm.name}`;
      modalBody.innerHTML = `Thời gian: <strong>${tm.start}</strong> đến <strong>${tm.end}</strong>`;
    } else {
      modalTitle.textContent = `Tiết ${code || "?"}`;
      modalBody.innerHTML = `Không tìm thấy thông tin thời gian cho mã tiết này.`;
    }
    modalBack.style.display = "flex";
  }

  // Helper: escape HTML
  function escapeHtml(str) {
    return str.replace(/[&<>"]/g, function(tag) {
      const charsToReplace = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' };
      return charsToReplace[tag] || tag;
    });
  }

  // Helper format HH:MM with leading zeros
  function formatHM(h,m) {
    const hh = String(h).padStart(2,"0");
    const mm = String(m).padStart(2,"0");
    return `${hh}:${mm}`;
  }

  // Build empty table if fetch fails
  function buildEmptyTable() {
    const t = document.getElementById("tkb-body");
    t.innerHTML = "";
    const tr1 = document.createElement("tr");
    tr1.className = "session-row";
    const td1 = document.createElement("td");
    td1.colSpan = 7; td1.className = "session-td"; td1.textContent = "Buổi Sáng";
    tr1.appendChild(td1); t.appendChild(tr1);
    for (let i=0;i<5;i++){
      const tr = document.createElement("tr"); tr.className = "morning";
      const label = document.createElement("td"); label.textContent = `Tiết ${i+1}`; tr.appendChild(label);
      for (let c=0;c<6;c++){ const td = document.createElement("td"); td.innerHTML='<span class="empty">—</span>'; tr.appendChild(td); }
      t.appendChild(tr);
    }
    const tr2 = document.createElement("tr");
    tr2.className = "session-row";
    const td2 = document.createElement("td");
    td2.colSpan = 7; td2.className = "session-td"; td2.textContent = "Buổi Chiều";
    tr2.appendChild(td2); t.appendChild(tr2);
    for (let i=0;i<5;i++){
      const tr = document.createElement("tr"); tr.className = "afternoon";
      const label = document.createElement("td"); label.textContent = `Tiết ${i+1}`; tr.appendChild(label);
      for (let c=0;c<6;c++){ const td = document.createElement("td"); td.innerHTML='<span class="empty">—</span>'; tr.appendChild(td); }
      t.appendChild(tr);
    }
  }

})();
</script>
</body>
</html>
